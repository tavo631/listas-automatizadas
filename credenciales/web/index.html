<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CredencialesUTN - Sistema Integral</title>
    
    <!-- ==========================================
         BRAYAN POOM - ARQUITECTURA FRONTEND
         Stack: Tailwind, Google Fonts, Phosphor, Chart.js
    ========================================== -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animaciones de Transici칩n */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Efecto Esc치ner */
        .scan-line {
            width: 100%; height: 2px; background: #10b981;
            position: absolute; top: 0; left: 0;
            animation: scan 2s infinite linear;
            box-shadow: 0 0 10px #10b981;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Validaciones Visuales de Formularios */
        input:focus { outline: none; border-color: #15803d; ring: 2px; }
        input:invalid:not(:placeholder-shown) { border-color: #ef4444; }
        input:valid:not(:placeholder-shown) { border-color: #22c55e; }

        .hidden-menu { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .visible-menu { transform: translateX(0); transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <!-- NAVBAR (Dise침o UX: Brayan Poom) -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <nav class="container mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <!-- Identidad -->
            <a href="#" onclick="router('home')" class="flex items-center gap-2 group flex-shrink-0">
                <div class="bg-green-700 text-white p-1.5 rounded-lg group-hover:bg-green-800 transition">
                    <i class="ph ph-identification-card text-2xl"></i>
                </div>
                <span class="font-bold text-xl tracking-tight text-slate-900 hidden sm:block">Credenciales<span class="text-green-700">UTN</span></span>
            </a>

            <!-- Buscador Simulado -->
            <div class="hidden md:block flex-grow max-w-sm mx-4">
                <div class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                        <i class="ph ph-magnifying-glass"></i>
                    </div>
                    <input type="text" placeholder="Buscar matr칤cula..." 
                        class="w-full bg-slate-100 text-sm rounded-full pl-10 pr-4 py-2 border-transparent focus:bg-white focus:border-green-500 transition"
                        onkeydown="if(event.key === 'Enter') alert('B칰squeda simulada: ' + this.value)">
                </div>
            </div>

            <!-- Men칰 Desktop -->
            <div class="hidden lg:flex items-center gap-6">
                <ul class="flex gap-5 text-sm font-medium text-slate-600">
                    <li><a href="#" onclick="router('home')" class="hover:text-green-700 transition nav-link" id="nav-home">Inicio</a></li>
                    <li><a href="#" onclick="router('servicios')" class="hover:text-green-700 transition nav-link" id="nav-servicios">Servicios</a></li>
                    <li><a href="#" onclick="router('proyecto')" class="hover:text-green-700 transition nav-link text-green-700" id="nav-proyecto"><i class="ph ph-book-bookmark"></i> Proyecto</a></li>
                    <li><a href="#" onclick="router('scanner')" class="hover:text-green-700 transition nav-link" id="nav-scanner">Esc치ner</a></li>
                </ul>
                <div class="h-6 w-px bg-gray-300"></div>
                <!-- Men칰 Utilidad -->
                <div class="flex items-center gap-3">
                    <button onclick="router('buzon')" class="text-slate-500 hover:text-green-700 transition" title="Buz칩n"><i class="ph ph-tray text-xl"></i></button>
                    <div id="authButtonContainer">
                        <button onclick="router('login')" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition flex items-center gap-2">
                            <i class="ph ph-sign-in"></i> Acceso
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bot칩n M칩vil -->
            <button onclick="toggleMobileMenu()" class="lg:hidden text-slate-600 text-2xl"><i class="ph ph-list"></i></button>
        </nav>
        
        <!-- Men칰 M칩vil -->
        <div id="mobile-menu" class="fixed inset-0 bg-white z-40 hidden-menu lg:hidden flex flex-col pt-20 px-6 space-y-4 shadow-2xl">
            <button onclick="toggleMobileMenu()" class="absolute top-4 right-4 text-slate-600 text-2xl"><i class="ph ph-x"></i></button>
            <a href="#" onclick="router('home'); toggleMobileMenu()" class="text-lg border-b pb-2">Inicio</a>
            <a href="#" onclick="router('servicios'); toggleMobileMenu()" class="text-lg border-b pb-2">Servicios</a>
            <a href="#" onclick="router('scanner'); toggleMobileMenu()" class="text-lg border-b pb-2">Esc치ner</a>
            <a href="#" onclick="router('registro'); toggleMobileMenu()" class="text-lg border-b pb-2">Registro</a>
            <a href="#" onclick="router('proyecto'); toggleMobileMenu()" class="text-lg border-b pb-2 font-bold text-green-700">Documentaci칩n</a>
            <a href="#" onclick="router('sitemap'); toggleMobileMenu()" class="text-lg border-b pb-2 text-gray-500">Mapa del Sitio</a>
            <a href="#" onclick="router('login'); toggleMobileMenu()" class="mt-4 bg-green-700 text-white text-center py-3 rounded-lg font-bold">Portal Alumno</a>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL (SPA) -->
    <main id="app" class="flex-grow container mx-auto px-4 py-8 relative min-h-[60vh]">
        <!-- Loading Spinner -->
        <div class="flex justify-center items-center h-full">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-700"></div>
        </div>
    </main>

    <!-- Chat Flotante (Utilidad) -->
    <div class="fixed bottom-6 right-6 z-50">
        <button onclick="toggleChat()" class="bg-green-700 hover:bg-green-800 text-white p-4 rounded-full shadow-lg transition hover:scale-105 flex items-center gap-2">
            <i class="ph ph-chat-circle-dots text-2xl"></i>
        </button>
        <div id="chat-window" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col">
            <div class="bg-slate-900 text-white p-3 flex justify-between items-center">
                <span class="font-bold text-sm">Soporte UTN</span>
                <button onclick="toggleChat()"><i class="ph ph-x"></i></button>
            </div>
            <div class="h-64 p-4 bg-gray-50 overflow-y-auto text-sm">
                <div class="bg-white p-2 rounded-lg shadow-sm border max-w-[90%] mb-2">춰Hola! 쯇roblemas con tu credencial?</div>
            </div>
            <div class="p-2 border-t bg-white flex gap-2">
                <input type="text" placeholder="Mensaje..." class="flex-grow text-xs border rounded p-2">
                <button class="text-green-700"><i class="ph ph-paper-plane-right text-xl"></i></button>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="bg-white border-t border-gray-200 mt-auto py-8 text-sm text-gray-500">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>춸 2026 CredencialesUTN. Todos los derechos reservados.</div>
            <div class="text-center md:text-right">
                <p>Desarrollado por: <strong>Jos칠 Gustavo L칩pez Garc칤a</strong> & <strong>Brayan Poom</strong></p>
                <div class="flex gap-4 justify-center md:justify-end mt-2">
                    <a href="#" onclick="router('sitemap')" class="hover:text-green-700">Mapa del Sitio</a>
                    <a href="#" onclick="router('contacto')" class="hover:text-green-700">Contacto</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- ==========================================
         JOS칄 GUSTAVO - L칍GICA BACKEND & FIREBASE
    ========================================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. CONFIGURACI칍N FIREBASE (Tus Credenciales Reales)
        const myFirebaseConfig = {
          apiKey: "AIzaSyCoaX6L0SEHMfQBfbxBDYZivoFYhf1Afk8",
          authDomain: "asistenciautn-a61f8.firebaseapp.com",
          projectId: "asistenciautn-a61f8",
          storageBucket: "asistenciautn-a61f8.firebasestorage.app",
          messagingSenderId: "813249116802",
          appId: "1:813249116802:web:35c73740597e2d477dd29b",
          measurementId: "G-NN3YJWL7JH"
        };

        // Selecci칩n din치mica de entorno
        let firebaseConfig, appId;
        if (myFirebaseConfig) {
            firebaseConfig = myFirebaseConfig;
            appId = "asistenciautn-a61f8"; // ID real del proyecto para rutas
        } else {
            // Entorno de prueba (fallback si falla la carga)
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables de Sesi칩n
        let currentUser = null; 
        let currentStudent = null;
        let tempStudentFor2FA = null;

        // Helper para colecciones: Ajuste importante
        // Si usamos tu config, las colecciones van directo a la ra칤z (students, classes, etc.)
        // Si usamos el entorno de prueba del chat, van a /artifacts/...
        const getCol = (name) => {
            if (myFirebaseConfig) return collection(db, name);
            return collection(db, 'artifacts', appId, 'public', 'data', name);
        };

        // Auth Init
        async function initApp() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && !myFirebaseConfig) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // En tu app real, quiz치s quieras evitar login an칩nimo autom치tico
                    // Pero para que funcione la primera vez sin usuarios, lo dejamos:
                    // await signInAnonymously(auth); 
                }
            } catch (e) { console.error("Auth:", e); }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Intentamos crear datos de prueba si tu BD est치 vac칤a
                await seedDatabase();
                router('home');
            } else {
                router('home');
            }
        });

        // Crear datos si est치 vac칤o (Seed)
        async function seedDatabase() {
            try {
                const snap = await getDocs(getCol('classes'));
                if (snap.empty) {
                    console.log("Inicializando base de datos...");
                    const classes = [
                        { nombre: "Programaci칩n Web", hora: "07:00", total: 30 },
                        { nombre: "Base de Datos", hora: "09:00", total: 30 },
                        { nombre: "Ingl칠s V", hora: "11:00", total: 30 }
                    ];
                    for (const c of classes) await addDoc(getCol('classes'), c);
                    
                    // Alumno demo por defecto
                    await addDoc(getCol('students'), {
                        nombre: "Alumno Demo",
                        matricula: "2023001",
                        email: "demo@utn.edu.mx",
                        password: "Password123", // Demo
                        carrera: "TI",
                        foto: "https://randomuser.me/api/portraits/men/32.jpg"
                    });
                }
            } catch (e) {
                console.log("Nota: Si ves error de permisos es normal hasta que configures las reglas en Firestore console.");
            }
        }

        // ==========================================
        //  VISTAS (TEMPLATES) - BRAYAN POOM (UI/UX)
        // ==========================================
        const templates = {
            // 1. HOME
            home: `
                <div class="fade-in max-w-5xl mx-auto text-center py-10">
                    <div class="bg-gradient-to-br from-green-900 to-slate-900 rounded-3xl p-10 text-white shadow-2xl relative overflow-hidden">
                        <div class="relative z-10">
                            <span class="bg-white/20 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Sistema v3.0</span>
                            <h1 class="text-4xl md:text-6xl font-bold my-6">Control de Acceso <span class="text-green-400">Inteligente</span></h1>
                            <p class="text-lg text-gray-300 mb-8 max-w-2xl mx-auto">Plataforma segura para la gesti칩n de identidad y asistencia acad칠mica mediante tecnolog칤a web progresiva.</p>
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <button onclick="router('scanner')" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition transform hover:-translate-y-1"><i class="ph ph-qr-code"></i> Escanear</button>
                                <button onclick="router('registro')" class="bg-white/10 hover:bg-white/20 border border-white/20 text-white px-8 py-3 rounded-xl font-bold transition">Registrarse</button>
                            </div>
                        </div>
                        <!-- Decoraci칩n de fondo -->
                        <div class="absolute top-0 right-0 w-64 h-64 bg-green-500/20 rounded-full blur-3xl -mr-16 -mt-16"></div>
                        <div class="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl -ml-16 -mb-16"></div>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-8 mt-16 text-left">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-green-100 text-green-700 rounded-lg flex items-center justify-center text-2xl mb-4"><i class="ph ph-shield-check"></i></div>
                            <h3 class="font-bold text-lg mb-2">Seguridad 2FA</h3>
                            <p class="text-gray-500 text-sm">Protecci칩n de identidad mediante verificaci칩n de dos pasos.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-blue-100 text-blue-700 rounded-lg flex items-center justify-center text-2xl mb-4"><i class="ph ph-chart-pie-slice"></i></div>
                            <h3 class="font-bold text-lg mb-2">Reportes en Vivo</h3>
                            <p class="text-gray-500 text-sm">Visualiza tus faltas y asistencias en tiempo real.</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-md transition">
                            <div class="w-12 h-12 bg-purple-100 text-purple-700 rounded-lg flex items-center justify-center text-2xl mb-4"><i class="ph ph-devices"></i></div>
                            <h3 class="font-bold text-lg mb-2">Multiplataforma</h3>
                            <p class="text-gray-500 text-sm">Accede desde cualquier dispositivo sin instalar nada.</p>
                        </div>
                    </div>
                </div>
            `,

            // 2. DOCUMENTACI칍N ESTRAT칄GICA (Solicitado en el Prompt)
            proyecto: `
                <div class="fade-in max-w-4xl mx-auto bg-white p-8 md:p-12 rounded-2xl shadow-xl border border-gray-100">
                    <div class="border-b pb-6 mb-8 flex justify-between items-end">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-900">Planeaci칩n Estrat칠gica</h2>
                            <p class="text-slate-500">Documento Ejecutivo de Proyecto</p>
                        </div>
                        <div class="text-right hidden sm:block">
                            <img src="https://ui-avatars.com/api/?name=UT&background=15803d&color=fff" class="w-12 h-12 rounded-lg">
                        </div>
                    </div>

                    <div class="space-y-10">
                        <!-- An치lisis Organizacional -->
                        <section>
                            <h3 class="flex items-center gap-2 text-xl font-bold text-green-700 mb-4"><i class="ph ph-buildings"></i> 1. An치lisis del Modelo Organizacional</h3>
                            <div class="bg-slate-50 p-6 rounded-xl text-slate-700 space-y-3">
                                <p><strong>Estructura:</strong> Jer치rquico-Funcional (Rector칤a &rarr; Docentes &rarr; Alumnos).</p>
                                <p><strong>Problem치tica:</strong> Procesos manuales en papel, lentitud en reportes y riesgo de errores humanos.</p>
                                <p><strong>Soluci칩n:</strong> Automatizaci칩n digital con flujo ascendente de datos en tiempo real.</p>
                            </div>
                        </section>

                        <!-- An치lisis Entorno -->
                        <section>
                            <h3 class="flex items-center gap-2 text-xl font-bold text-green-700 mb-4"><i class="ph ph-globe"></i> 2. An치lisis del Entorno</h3>
                            <ul class="list-disc list-inside space-y-2 text-slate-700 ml-4">
                                <li><strong>Tecnol칩gico:</strong> Alta penetraci칩n de smartphones (99%) permite uso de PWA sin hardware costoso.</li>
                                <li><strong>Social:</strong> Demanda estudiantil de inmediatez y transparencia en calificaciones.</li>
                            </ul>
                        </section>

                        <!-- Plan Estrat칠gico -->
                        <section>
                            <h3 class="flex items-center gap-2 text-xl font-bold text-green-700 mb-4"><i class="ph ph-strategy"></i> 3. Plan Estrat칠gico</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="bg-green-50 p-5 rounded-lg border border-green-100">
                                    <h4 class="font-bold mb-2">Misi칩n</h4>
                                    <p class="text-sm">Proveer una plataforma digital segura y eficiente para la gesti칩n de asistencia y validaci칩n de identidad.</p>
                                </div>
                                <div class="bg-blue-50 p-5 rounded-lg border border-blue-100">
                                    <h4 class="font-bold mb-2">Visi칩n (2026)</h4>
                                    <p class="text-sm">Ser el est치ndar de control acad칠mico digital en la UTN, reconocidos por la seguridad y UX.</p>
                                </div>
                            </div>
                            <div class="mt-6">
                                <h4 class="font-bold mb-2">Objetivos y Metas</h4>
                                <ul class="list-disc list-inside text-sm text-slate-600">
                                    <li>Automatizaci칩n 100% (Cero Papel).</li>
                                    <li>Seguridad Total con Verificaci칩n 2FA.</li>
                                    <li>Reducir tiempo de toma de asistencia a < 2 minutos.</li>
                                </ul>
                            </div>
                        </section>

                        <!-- Recursos y Responsables (Datos del Equipo) -->
                        <section class="border-t pt-8">
                            <h3 class="flex items-center gap-2 text-xl font-bold text-slate-900 mb-6"><i class="ph ph-users-three"></i> Equipo de Desarrollo</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 bg-slate-900 text-white rounded-full flex items-center justify-center font-bold">JG</div>
                                    <div>
                                        <h4 class="font-bold text-lg">Jos칠 Gustavo L칩pez Garc칤a</h4>
                                        <p class="text-green-600 text-sm font-semibold">L칤der de Proyecto & Backend</p>
                                        <p class="text-xs text-gray-500 mt-1">L칩gica, Base de Datos, Seguridad, Servidores.</p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 bg-gray-200 text-slate-700 rounded-full flex items-center justify-center font-bold">BP</div>
                                    <div>
                                        <h4 class="font-bold text-lg">Brayan Poom</h4>
                                        <p class="text-blue-600 text-sm font-semibold">Arquitecto Frontend & UX/UI</p>
                                        <p class="text-xs text-gray-500 mt-1">Interfaz, Dise침o Visual, Mapa del Sitio, Navegaci칩n.</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            `,

            // 3. REGISTRO (Con Validaci칩n Regex)
            registro: `
                <div class="fade-in max-w-md mx-auto mt-10">
                    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
                        <h2 class="text-2xl font-bold text-center mb-6">Nuevo Alumno</h2>
                        <form id="regForm" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Nombre Completo</label>
                                <input type="text" id="regNombre" required class="w-full p-3 rounded-lg border bg-gray-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Matr칤cula</label>
                                <input type="text" id="regMatricula" required class="w-full p-3 rounded-lg border bg-gray-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Correo Institucional</label>
                                <input type="email" id="regEmail" required class="w-full p-3 rounded-lg border bg-gray-50 focus:bg-white transition">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Carrera</label>
                                <select id="regCarrera" class="w-full p-3 rounded-lg border bg-gray-50"><option>Ing. Software</option><option>Mecatr칩nica</option><option>Administraci칩n</option></select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Contrase침a</label>
                                <input type="password" id="regPass" required pattern="(?=.*\\d)(?=.*[A-Z]).{8,}" title="M칤nimo 8 caracteres, 1 may칰scula, 1 n칰mero" class="w-full p-3 rounded-lg border bg-gray-50 focus:bg-white transition">
                                <p class="text-xs text-gray-400 mt-1">Min. 8 caracteres, 1 May칰scula, 1 N칰mero.</p>
                            </div>
                            <button type="submit" class="w-full bg-green-700 text-white font-bold py-3 rounded-lg hover:bg-green-800 transition shadow-lg">Registrar</button>
                        </form>
                    </div>
                </div>
            `,

            // 4. LOGIN (Paso 1)
            login: `
                <div class="fade-in max-w-sm mx-auto mt-16">
                    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                        <div class="text-center mb-8">
                            <div class="inline-block p-3 bg-green-100 text-green-700 rounded-full mb-4"><i class="ph ph-lock-key text-3xl"></i></div>
                            <h2 class="text-2xl font-bold">Acceso Seguro</h2>
                        </div>
                        <form id="loginForm" class="space-y-4">
                            <input type="text" id="logMatricula" placeholder="Matr칤cula (Ej: 2023001)" value="2023001" required class="w-full p-3 rounded-lg border focus:ring-2 ring-green-200">
                            <input type="password" id="logPass" placeholder="Contrase침a" value="Password123" required class="w-full p-3 rounded-lg border focus:ring-2 ring-green-200">
                            <div class="text-right"><a href="#" onclick="alert('Se ha enviado un correo de recuperaci칩n.')" class="text-xs text-green-600 font-medium">쯆lvidaste tu contrase침a?</a></div>
                            <div id="loginMsg" class="text-red-500 text-xs text-center hidden"></div>
                            <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition">Ingresar</button>
                        </form>
                    </div>
                </div>
            `,

            // 5. VERIFICACI칍N 2FA
            verification: `
                <div class="fade-in max-w-sm mx-auto mt-16 text-center">
                    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
                        <div class="mb-6 text-blue-600"><i class="ph ph-shield-check text-5xl"></i></div>
                        <h2 class="text-2xl font-bold mb-2">Verificaci칩n 2FA</h2>
                        <p class="text-gray-500 text-sm mb-6">Ingresa el c칩digo enviado a tu correo.</p>
                        <form id="form2fa">
                            <input type="text" id="code2fa" placeholder="0000" maxlength="4" class="w-full text-center text-3xl tracking-widest font-bold p-3 border rounded-lg mb-4 focus:border-blue-500">
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">Verificar</button>
                        </form>
                    </div>
                </div>
            `,

            // 6. DASHBOARD (Gr치ficas)
            dashboard: `
                <div class="fade-in max-w-6xl mx-auto">
                    <div id="dashHeader" class="bg-white p-6 rounded-2xl shadow-sm border mb-8 flex items-center gap-4">
                        <!-- Inyectado por JS -->
                    </div>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border">
                            <h3 class="font-bold mb-4">Reporte de Asistencia Semanal</h3>
                            <canvas id="attendanceChart"></canvas>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-green-600 text-white p-6 rounded-2xl shadow-lg">
                                <div class="text-3xl font-bold mb-1">95%</div>
                                <div class="text-green-100 text-sm">Asistencia Global</div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                                <h3 class="font-bold mb-4">Pr칩ximas Clases</h3>
                                <ul class="space-y-3 text-sm">
                                    <li class="flex justify-between border-b pb-2"><span>Prog. Web</span> <span class="text-gray-500">07:00 AM</span></li>
                                    <li class="flex justify-between border-b pb-2"><span>Base de Datos</span> <span class="text-gray-500">09:00 AM</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-8">
                        <button onclick="logout()" class="text-red-500 font-medium hover:underline">Cerrar Sesi칩n</button>
                    </div>
                </div>
            `,

            // 7. ESC츼NER
            scanner: `
                <div class="fade-in max-w-md mx-auto text-center">
                    <h2 class="text-2xl font-bold mb-6">Esc치ner de Asistencia</h2>
                    <div class="bg-black rounded-2xl overflow-hidden relative h-80 mb-6 group cursor-pointer shadow-2xl" onclick="document.getElementById('fileInput').click()">
                        <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1555421689-d68471e189f2?auto=format&fit=crop&q=80')] bg-cover opacity-50"></div>
                        <div class="scan-line z-10"></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center z-20 text-white">
                            <i class="ph ph-camera text-4xl mb-2"></i>
                            <span class="text-sm font-medium">Toque para escanear QR</span>
                        </div>
                        <input type="file" id="fileInput" class="hidden">
                    </div>
                    <div id="scanRes" class="hidden p-4 bg-green-100 text-green-800 rounded-xl font-bold">
                        <i class="ph ph-check-circle"></i> Asistencia Registrada
                    </div>
                </div>
            `,

            // 8. SERVICIOS
            servicios: `
                <div class="fade-in max-w-5xl mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-10">Nuestros Servicios</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="bg-white p-8 rounded-2xl shadow-sm border hover:-translate-y-2 transition duration-300">
                            <div class="w-14 h-14 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-3xl mb-6"><i class="ph ph-scan"></i></div>
                            <h3 class="text-xl font-bold mb-3">Lectura Digital</h3>
                            <p class="text-gray-500">Reconocimiento OCR avanzado para extracci칩n de datos de credenciales f칤sicas.</p>
                        </div>
                        <div class="bg-white p-8 rounded-2xl shadow-sm border hover:-translate-y-2 transition duration-300">
                            <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mb-6"><i class="ph ph-database"></i></div>
                            <h3 class="text-xl font-bold mb-3">Nube Segura</h3>
                            <p class="text-gray-500">Tus datos acad칠micos resguardados en servidores de alta disponibilidad.</p>
                        </div>
                        <div class="bg-white p-8 rounded-2xl shadow-sm border hover:-translate-y-2 transition duration-300">
                            <div class="w-14 h-14 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-3xl mb-6"><i class="ph ph-chart-bar"></i></div>
                            <h3 class="text-xl font-bold mb-3">Anal칤tica</h3>
                            <p class="text-gray-500">Reportes detallados de asistencia para alumnos y docentes.</p>
                        </div>
                    </div>
                </div>
            `,
             
            // 9. SITEMAP
            sitemap: `
                <div class="fade-in max-w-3xl mx-auto">
                    <h2 class="text-3xl font-bold mb-8 border-b pb-4">Mapa del Sitio</h2>
                    <ul class="space-y-4 text-lg">
                        <li class="pl-4 border-l-4 border-green-500 font-bold"><a href="#" onclick="router('home')">Inicio</a></li>
                        <li class="pl-4 border-l-4 border-gray-300 ml-4"><a href="#" onclick="router('servicios')">Servicios</a></li>
                        <li class="pl-4 border-l-4 border-gray-300 ml-4"><a href="#" onclick="router('registro')">Registro</a></li>
                        <li class="pl-4 border-l-4 border-gray-300 ml-4"><a href="#" onclick="router('scanner')">Esc치ner</a></li>
                        <li class="pl-4 border-l-4 border-blue-300 ml-4"><a href="#" onclick="router('login')">Portal Alumno (Login)</a></li>
                        <li class="pl-4 border-l-4 border-purple-300 ml-4 font-bold text-green-700"><a href="#" onclick="router('proyecto')">Documentaci칩n del Proyecto</a></li>
                    </ul>
                </div>
            `,

            // 10. CONTACTO
            contacto: `
                <div class="fade-in max-w-lg mx-auto bg-white p-8 rounded-2xl shadow-lg border">
                    <h2 class="text-2xl font-bold mb-6">Cont치ctanos</h2>
                    <form onsubmit="event.preventDefault(); alert('Mensaje enviado'); router('home');">
                         <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Nombre</label>
                            <input type="text" required class="w-full p-2 border rounded">
                         </div>
                         <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Correo</label>
                            <input type="email" required class="w-full p-2 border rounded">
                         </div>
                         <div class="mb-4">
                            <label class="block text-sm font-bold mb-1">Mensaje</label>
                            <textarea required class="w-full p-2 border rounded h-24"></textarea>
                         </div>
                         <button class="w-full bg-slate-900 text-white py-2 rounded font-bold">Enviar</button>
                    </form>
                </div>
            `,

            // 11. 404 (Gesti칩n de Errores)
            '404': `
                <div class="fade-in text-center py-20">
                    <h1 class="text-9xl font-bold text-gray-200">404</h1>
                    <p class="text-2xl font-bold text-slate-800 -mt-10 mb-6 relative z-10">P치gina no encontrada</p>
                    <p class="text-gray-500 mb-8">Parece que te has perdido en el campus digital.</p>
                    <button onclick="router('home')" class="bg-green-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-green-700 transition">Volver al Inicio</button>
                </div>
            `
        };

        // ==========================================
        //  CONTROLADOR DE RUTAS (ROUTER SPA)
        // ==========================================
        window.router = async (route) => {
            const app = document.getElementById('app');
            
            // Navegaci칩n B치sica
            if (templates[route]) {
                app.innerHTML = templates[route];
            } else {
                app.innerHTML = templates['404'];
            }

            // Actualizar estado del Nav
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('text-green-700', 'font-bold'));
            if(document.getElementById(`nav-${route}`)) document.getElementById(`nav-${route}`).classList.add('text-green-700', 'font-bold');

            // L칩gica Espec칤fica por Vista
            if (route === 'dashboard') {
                if (!currentStudent) { router('login'); return; }
                renderDashboard();
            } else if (route === 'login') {
                bindLogin();
            } else if (route === 'registro') {
                bindRegister();
            } else if (route === 'verification') {
                bind2FA();
            } else if (route === 'scanner') {
                bindScanner();
            }
        };

        // ==========================================
        //  L칍GICA DE NEGOCIO (Controladores)
        // ==========================================

        // 1. REGISTRO
        function bindRegister() {
            document.getElementById('regForm').onsubmit = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(getCol('students'), {
                        nombre: document.getElementById('regNombre').value,
                        matricula: document.getElementById('regMatricula').value,
                        email: document.getElementById('regEmail').value,
                        carrera: document.getElementById('regCarrera').value,
                        password: document.getElementById('regPass').value, // En prod usar hash
                        foto: `https://ui-avatars.com/api/?name=${document.getElementById('regNombre').value}&background=random`
                    });
                    alert('Registro exitoso. Inicia sesi칩n.');
                    router('login');
                } catch (err) { alert('Error: ' + err.message); }
            };
        }

        // 2. LOGIN & 2FA
        function bindLogin() {
            document.getElementById('loginForm').onsubmit = async (e) => {
                e.preventDefault();
                const mat = document.getElementById('logMatricula').value;
                const pass = document.getElementById('logPass').value;
                
                const q = query(getCol('students'), where("matricula", "==", mat));
                const snap = await getDocs(q);
                
                let valid = false;
                snap.forEach(doc => {
                    if (doc.data().password === pass) {
                        valid = true;
                        tempStudentFor2FA = { id: doc.id, ...doc.data() };
                    }
                });

                if (valid) {
                    // Simulaci칩n 2FA
                    const code = Math.floor(1000 + Math.random() * 9000);
                    sessionStorage.setItem('2fa', code);
                    alert(`游댏 C칍DIGO DE SEGURIDAD: ${code}\n(En un sistema real, esto llegar칤a a tu correo)`);
                    router('verification');
                } else {
                    document.getElementById('loginMsg').innerText = "Credenciales Incorrectas";
                    document.getElementById('loginMsg').classList.remove('hidden');
                }
            };
        }

        function bind2FA() {
            document.getElementById('form2fa').onsubmit = (e) => {
                e.preventDefault();
                if (document.getElementById('code2fa').value === sessionStorage.getItem('2fa')) {
                    currentStudent = tempStudentFor2FA;
                    tempStudentFor2FA = null;
                    updateAuthUI();
                    router('dashboard');
                } else {
                    alert('C칩digo incorrecto');
                }
            };
        }

        // 3. DASHBOARD & CHART.JS
        async function renderDashboard() {
            document.getElementById('dashHeader').innerHTML = `
                <img src="${currentStudent.foto}" class="w-16 h-16 rounded-full border-2 border-green-500">
                <div>
                    <h2 class="text-xl font-bold">Hola, ${currentStudent.nombre}</h2>
                    <p class="text-gray-500 text-sm">${currentStudent.carrera} | ${currentStudent.matricula}</p>
                </div>
            `;

            // Gr치fica
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Lun', 'Mar', 'Mi칠', 'Jue', 'Vie'],
                    datasets: [{
                        label: 'Asistencias',
                        data: [1, 1, 1, 0, 1],
                        backgroundColor: '#16a34a'
                    }]
                }
            });
        }

        // 4. SCANNER
        function bindScanner() {
            document.getElementById('fileInput').onchange = () => {
                document.getElementById('scanRes').classList.remove('hidden');
                setTimeout(async () => {
                    if(currentStudent) {
                        await addDoc(getCol('attendance'), {
                            studentId: currentStudent.id,
                            timestamp: new Date().toISOString()
                        });
                        alert('Asistencia registrada en la nube.');
                    } else {
                        alert('Escaneo simulado (Inicia sesi칩n para guardar).');
                    }
                }, 1000);
            };
        }

        // UTILS
        window.logout = () => {
            currentStudent = null;
            updateAuthUI();
            router('home');
        }

        function updateAuthUI() {
            const btn = document.getElementById('authButtonContainer');
            if(currentStudent) {
                btn.innerHTML = `<button onclick="router('dashboard')" class="text-green-700 font-bold text-sm">Mi Perfil</button>`;
            } else {
                btn.innerHTML = `<button onclick="router('login')" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-800 transition flex items-center gap-2"><i class="ph ph-sign-in"></i> Acceso</button>`;
            }
        }

        // Funciones Globales UI
        window.toggleMobileMenu = () => {
            const m = document.getElementById('mobile-menu');
            m.classList.toggle('hidden-menu');
            m.classList.toggle('visible-menu');
        }
        window.toggleChat = () => document.getElementById('chat-window').classList.toggle('hidden');

        // Init
        initApp();
        router('home');
    </script>
</body>
</html>
